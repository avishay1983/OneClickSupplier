# מדריך הגדרת המערכת - ספק בקליק

## 📋 תוכן עניינים

1. [הגדרות בסיסיות](#הגדרות-בסיסיות)
2. [הגדרות Supabase](#הגדרות-supabase)
3. [הגדרות מייל (Gmail)](#הגדרות-מייל)
4. [הגדרות AI](#הגדרות-ai)
5. [הגדרות אפליקציה](#הגדרות-אפליקציה)
6. [משתמשים והרשאות](#משתמשים-והרשאות)
7. [רשימת בדיקה להפעלה](#רשימת-בדיקה-להפעלה)

---

## 🔧 הגדרות בסיסיות

### הגדרות מערכת (בדשבורד)

גישה דרך: **דשבורד > הגדרות (⚙️)**

| הגדרה | תיאור | חובה |
|--------|--------|------|
| **קוד OTP ברירת מחדל** | קוד גיבוי לאימות ספקים (לשימוש פנימי בלבד) | ✅ |
| **שם מנהל רכש** | השם שיופיע במיילים ובחתימות | ✅ |
| **מייל מנהל רכש** | כתובת לקבלת התראות ואישורים | ✅ |
| **שם סמנכ"ל** | השם שיופיע באישורי סמנכ"ל | ✅ |
| **מייל סמנכ"ל** | כתובת לקבלת בקשות אישור VP | ✅ |

> ⚠️ **חשוב:** ללא הגדרת המיילים, מנגנון האישורים לא יעבוד!

---

## 🗄️ הגדרות Supabase

### סודות (Secrets) שנדרשים

גישה דרך: **Supabase Dashboard > Settings > Edge Functions**

| שם הסוד | תיאור | איך להשיג |
|---------|--------|-----------|
| `GMAIL_USER` | כתובת Gmail לשליחת מיילים | חשבון Gmail של הארגון |
| `GMAIL_APP_PASSWORD` | סיסמת אפליקציה של Gmail | [הוראות למטה](#יצירת-סיסמת-אפליקציה-ל-gmail) |
| `GOOGLE_GEMINI_API_KEY` | מפתח API ל-Google Gemini | [Google AI Studio](https://aistudio.google.com/apikey) |
| `ADMIN_EMAIL` | מייל מנהל לקבלת התראות הרשמה | כתובת מייל של מנהל המערכת |

### הגדרות Authentication

גישה דרך: **Supabase Dashboard > Authentication > URL Configuration**

| הגדרה | ערך |
|--------|------|
| **Site URL** | `https://your-domain.com` או URL של הפרויקט |
| **Redirect URLs** | הוסף את כל הכתובות הרלוונטיות (preview, production) |

### הגדרות Email Templates

גישה דרך: **Supabase Dashboard > Authentication > Email Templates**

מומלץ להתאים את תבניות המייל לעברית:
- Confirm signup
- Reset password
- Magic link

---

## 📧 הגדרות מייל

### יצירת סיסמת אפליקציה ל-Gmail

1. היכנס ל-[Google Account](https://myaccount.google.com/)
2. לך ל-**Security > 2-Step Verification** (וודא שמופעל)
3. גלול למטה ל-**App passwords**
4. צור סיסמת אפליקציה חדשה
5. העתק והזן ב-Supabase Secrets כ-`GMAIL_APP_PASSWORD`

> 💡 **טיפ:** השתמש בחשבון Gmail ייעודי לשליחת מיילים מהמערכת

### בדיקת תקינות שליחת מיילים

1. צור בקשת ספק חדשה
2. וודא שהמייל נשלח לספק
3. בדוק ב-Edge Function Logs אם יש שגיאות

---

## 🤖 הגדרות AI

### Google Gemini API

המערכת משתמשת ב-Google Gemini עבור:
- **זיהוי מסמכים אוטומטי** - סיווג סוג המסמך
- **חילוץ פרטי בנק** - קריאת נתונים מאישורי בנק
- **זיהוי מיקום חתימה** - מציאת מיקום החתימה בחוזים

#### קבלת מפתח API:
1. היכנס ל-[Google AI Studio](https://aistudio.google.com/apikey)
2. צור מפתח API חדש
3. הזן ב-Supabase Secrets כ-`GOOGLE_GEMINI_API_KEY`

---

## ⚙️ הגדרות אפליקציה

### תנאי תשלום ברירת מחדל

ברירת המחדל היא **"שוטף + 60"**. לשינוי, יש לעדכן את ערך ברירת המחדל בטבלת `vendor_requests`.

### סוגי ספקים

סוגי הספקים הקיימים:
- `general` - ספק כללי
- `claims` - ספק תביעות (כולל תת-קטגוריות)

### סטטוסים של ספקים

| סטטוס | תיאור |
|--------|--------|
| `pending` | ממתין לשליחה |
| `with_vendor` | נשלח לספק |
| `submitted` | הספק הגיש |
| `first_review` | בבדיקה ראשונית |
| `approved` | אושר |
| `rejected` | נדחה |
| `resent` | נשלח מחדש |

### סטטוסי CRM

| סטטוס | תיאור |
|--------|--------|
| `active` | פעיל |
| `suspended` | מושעה |
| `closed` | סגור |
| `vip` | ספק VIP |
| `security_approved` | אושר ביטחוני |

---

## 👥 משתמשים והרשאות

### הגדרת משתמש Admin ראשון

1. המשתמש נרשם דרך מסך ההתחברות
2. מנהל מערכת מאשר את המשתמש (מייל נשלח אוטומטית)
3. להגדרת Admin:
   - היכנס ל-Supabase Dashboard
   - לך לטבלת `user_roles`
   - הוסף שורה עם `user_id` של המשתמש ו-`role` = `admin`

### רמות הרשאה

| תפקיד | יכולות |
|--------|--------|
| **Admin** | גישה מלאה, ניהול משתמשים, הגדרות מערכת |
| **User** | צפייה ועבודה עם בקשות ספקים |

---

## ✅ רשימת בדיקה להפעלה

### לפני השקה:

- [ ] **Supabase Secrets מוגדרים:**
  - [ ] `GMAIL_USER`
  - [ ] `GMAIL_APP_PASSWORD`
  - [ ] `GOOGLE_GEMINI_API_KEY`
  - [ ] `ADMIN_EMAIL`

- [ ] **הגדרות Authentication:**
  - [ ] Site URL מוגדר
  - [ ] Redirect URLs מוגדרים
  - [ ] תבניות מייל מותאמות (אופציונלי)

- [ ] **הגדרות אפליקציה:**
  - [ ] קוד OTP ברירת מחדל
  - [ ] שם ומייל מנהל רכש
  - [ ] שם ומייל סמנכ"ל

- [ ] **משתמשים:**
  - [ ] משתמש Admin ראשון נוצר ואושר
  - [ ] הרשאות Admin הוגדרו בטבלת `user_roles`

- [ ] **בדיקות:**
  - [ ] שליחת מייל עובדת
  - [ ] יצירת בקשת ספק עובדת
  - [ ] העלאת מסמכים עובדת
  - [ ] זיהוי AI עובד

---

## 🔒 המלצות אבטחה

1. **החלף את קוד OTP ברירת המחדל** - אל תשתמש בקודים פשוטים
2. **הגדר RLS policies** - וודא שהנתונים מאובטחים
3. **בדוק הרשאות Storage** - וודא שמסמכים לא נגישים לכולם
4. **עדכן סיסמאות בקביעות** - במיוחד סיסמאות Gmail

---

## 📞 תמיכה

לשאלות ובעיות:
- בדוק את ה-Edge Function Logs ב-Supabase
- בדוק את ה-Console Logs בדפדפן
- וודא שכל הסודות מוגדרים נכון

---

*מעודכן לתאריך: דצמבר 2025*
