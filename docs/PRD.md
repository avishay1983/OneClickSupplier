# מסמך דרישות מוצר (PRD)
## מערכת "ספק בקליק" - הקמת וניהול ספקים

**גרסה:** 1.0  
**תאריך:** דצמבר 2024  
**ארגון:** ביטוח ישיר

---

## 1. סקירה כללית

### 1.1 מטרת המערכת
מערכת "ספק בקליק" היא פלטפורמה דיגיטלית מקיפה לניהול תהליך הקמת ספקים חדשים בארגון, מרגע יצירת הבקשה ועד לאישור הסופי וניהול שוטף של הספק.

### 1.2 קהל יעד
- **מנהלי רכש** - יצירת בקשות, מעקב ואישור ספקים
- **סמנכ"ל** - אישור וחתימה על הסכמים
- **מטפלים** - ניהול יומיומי של בקשות ספקים
- **ספקים** - מילוי טפסים, העלאת מסמכים, הגשת הצעות מחיר וקבלות
- **מנהלי מערכת** - ניהול משתמשים והגדרות

---

## 2. ארכיטקטורת המערכת

### 2.1 טכנולוגיות
- **Frontend:** React, TypeScript, Tailwind CSS, Shadcn/UI
- **Backend:** Supabase (PostgreSQL, Edge Functions, Storage, Auth)
- **AI:** Google Gemini / OpenAI לחילוץ מידע ממסמכים
- **Email:** Resend לשליחת התראות

### 2.2 מבנה נתונים עיקרי

#### טבלאות ראשיות:
| טבלה | תיאור |
|------|--------|
| `vendor_requests` | בקשות הקמת ספקים |
| `vendor_documents` | מסמכי ספקים |
| `vendor_quotes` | הצעות מחיר |
| `vendor_receipts` | קבלות |
| `vendor_ratings` | דירוגי ספקים |
| `vendor_status_history` | היסטוריית סטטוסים |
| `crm_history` | היסטוריית שינויים ב-CRM |
| `profiles` | פרופילי משתמשים |
| `user_roles` | תפקידי משתמשים |
| `pending_approvals` | בקשות אישור ממתינות |
| `app_settings` | הגדרות מערכת |

---

## 3. תהליכים עסקיים

### 3.1 תהליך הקמת ספק חדש

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   יצירת בקשה    │────▶│  הספק ממלא טופס │────▶│   בקרה ראשונה   │
│   ע"י מטפל      │     │   + מסמכים      │     │                 │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
         ┌───────────────────────────────────────────────┘
         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  אישור מנהל רכש │────▶│   חתימות על    │────▶│    ספק אושר     │
│   + סמנכ"ל      │     │    חוזה        │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

#### שלבים:

**שלב 1: יצירת בקשה**
- מטפל מתחבר למערכת
- יוצר בקשה חדשה עם פרטי הספק הבסיסיים
- המערכת שולחת קישור מאובטח לספק במייל
- הגדרת תוקף לקישור (ברירת מחדל: 7 ימים)

**שלב 2: מילוי טופס הספק**
- הספק מקבל קישור ייחודי
- אימות OTP דרך המייל
- העלאת מסמכים נדרשים:
  - אישור ניהול ספרים
  - אישור ניכוי מס במקור
  - צילום המחאה / אישור בנק
  - צילום חשבונית
- מילוי פרטים:
  - פרטי חברה (ח.פ, טלפון, כתובת)
  - אנשי קשר (הנהלת חשבונות, מכירות)
  - פרטי בנק
  - אמצעי תשלום
- העלאת הצעת מחיר חתומה (אופציונלי)

**שלב 3: עיבוד AI (אוטומטי)**
- חילוץ אוטומטי של פרטי בנק מהמסמכים
- סיווג מסמכים לסוג הנכון
- השוואה בין נתונים מחולצים לנתונים שהוזנו

**שלב 4: בקרה ראשונה**
- סקירת הטופס והמסמכים ע"י מטפל
- אישור או דחייה
- שליחה לאישור מנהלים

**שלב 5: אישור מנהלים**
- אישור מנהל רכש
- אישור סמנכ"ל (אם נדרש)
- התראות במייל לכל שלב

**שלב 6: חתימה על הסכם**
- חתימה דיגיטלית של סמנכ"ל (אם נדרש)
- חתימה דיגיטלית של מנהל רכש
- שמירת ההסכם החתום
- שליחת הודעה לספק

---

### 3.2 תהליך הצעות מחיר

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  שליחת בקשה    │────▶│  הספק מעלה      │────▶│   אישור מטפל   │
│  להצעת מחיר    │     │  הצעת מחיר     │     │                 │
└─────────────────┘     └─────────────────┘     └────────┬────────┘
                                                         │
         ┌───────────────────────────────────────────────┘
         ▼
┌─────────────────┐     ┌─────────────────┐
│  חתימת סמנכ"ל  │────▶│  חתימת מנהל    │
│  (אם נדרש)     │     │    רכש         │
└─────────────────┘     └─────────────────┘
```

#### תכונות:
- שליחת קישור לספק להעלאת הצעת מחיר
- ציון סכום ותיאור
- תהליך אישור רב-שלבי
- חתימה דיגיטלית על ההצעה
- קביעת מיקום חתימה מותאם אישית

---

### 3.3 תהליך קבלות

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  שליחת קישור   │────▶│  הספק מעלה     │────▶│   סקירה ואישור │
│   לקבלות       │     │    קבלות       │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

#### תכונות:
- שליחת קישור לספק להעלאת קבלות
- ציון סכום, תאריך ותיאור לכל קבלה
- סטטוסים: ממתין / אושר / נדחה
- סיבת דחייה במקרה הצורך

---

### 3.4 תהליך אישור משתמשים

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   הרשמה       │────▶│  ממתין לאישור  │────▶│   משתמש פעיל   │
│   למערכת       │     │    מנהל        │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

#### תכונות:
- כל משתמש חדש ממתין לאישור מנהל מערכת
- שליחת התראה למנהל על בקשה חדשה
- אפשרות לשלוח בקשה מחדש

---

## 4. מודולים וממשקים

### 4.1 לוח בקרה (Dashboard)

**נגיש ל:** משתמשים מאושרים

#### תצוגת מטפל:
- רשימת בקשות שהמשתמש מטפל בהן
- יצירת בקשה חדשה (יחידה או מרובה מאקסל)
- סטטוס כל בקשה
- פעולות: צפייה במסמכים, עריכה, שליחה מחדש, דחייה

#### תצוגת מנהל:
- רשימת בקשות הממתינות לחתימה
- גישה מהירה לחתימה דיגיטלית
- צפייה בכל הבקשות (אם אדמין)

#### פעולות זמינות:
| פעולה | תיאור |
|-------|--------|
| יצירת בקשה | יצירת בקשת הקמת ספק חדשה |
| יבוא מאקסל | יצירת מספר בקשות מקובץ אקסל |
| צפייה במסמכים | צפייה במסמכים שהספק העלה |
| עריכת בקשה | עדכון פרטי הבקשה |
| שליחה מחדש | שליחת קישור חדש לספק |
| אישור/דחייה | אישור או דחיית הבקשה |
| חתימה | חתימה דיגיטלית על הסכם |
| שליחת קישור הצעה | שליחת קישור להגשת הצעת מחיר |
| שליחת קישור קבלות | שליחת קישור להעלאת קבלות |

---

### 4.2 טופס ספק (VendorForm)

**נגיש ל:** ספקים עם קישור תקף

#### שלב 1: העלאת מסמכים
- העלאת 4 מסמכים נדרשים
- סיווג אוטומטי של סוג המסמך
- חילוץ אוטומטי של נתונים
- התראה על אי-התאמה בין סוג המסמך הצפוי לזיהוי

#### שלב 2: מילוי פרטים
- פרטי חברה ממולאים אוטומטית (מ-OCR)
- בדיקת תקינות פרטי בנק
- בחירת אמצעי תשלום
- העלאת הצעת מחיר חתומה (אופציונלי)

#### אימות:
- אימות OTP דרך מייל הספק
- תוקף קישור מוגבל

---

### 4.3 מערכת CRM

**נגיש ל:** משתמשים מאושרים

#### תכונות:
- רשימת כל הספקים המאושרים
- חיפוש וסינון לפי:
  - סטטוס (פעיל, מושהה, סגור, VIP, אושר ביטחון)
  - שם ספק
  - סוג ספק
- ניהול סטטוס ספק
- צפייה בהיסטוריית שינויים
- דירוג ספקים (1-5 כוכבים)
- ניהול הצעות מחיר
- ניהול קבלות

#### לשוניות:
| לשונית | תיאור |
|--------|--------|
| ספקים | רשימת כל הספקים המאושרים |
| הצעות מחיר | כל הצעות המחיר בכל הסטטוסים |
| קבלות | כל הקבלות הממתינות לסקירה |

---

### 4.4 עמוד אישור הצעת מחיר (QuoteApproval)

**נגיש ל:** מנהלים עם קישור תקף

#### תכונות:
- צפייה בהצעת המחיר
- אישור/דחייה
- חתימה דיגיטלית על ההצעה
- קביעת מיקום חתימה מותאם אישית

---

### 4.5 עמוד העלאת קבלות (VendorReceipts)

**נגיש ל:** ספקים עם קישור תקף

#### תכונות:
- העלאת קבלה חדשה
- ציון פרטי קבלה (סכום, תאריך, תיאור)
- צפייה בקבלות קודמות וסטטוסן

---

### 4.6 הגדרות (Settings)

**נגיש ל:** אדמינים

#### הגדרות זמינות:
| הגדרה | תיאור |
|-------|--------|
| vp_email | אימייל סמנכ"ל |
| vp_name | שם סמנכ"ל |
| car_manager_email | אימייל מנהל רכש |
| car_manager_name | שם מנהל רכש |
| admin_email | אימייל אדמין |
| admin_name | שם אדמין |

---

## 5. סטטוסים

### 5.1 סטטוסי בקשת ספק

| סטטוס | תיאור | תנאי מעבר |
|-------|--------|-----------|
| `pending` | ממתין | נוצרה בקשה |
| `with_vendor` | ממתין לספק | נשלח קישור לספק |
| `submitted` | הוגש | הספק שלח את הטופס |
| `first_review` | בקרה ראשונה | עובר סקירה ראשונית |
| `approved` | אושר | כל האישורים והחתימות הושלמו |
| `resent` | נשלח מחדש | הקישור נשלח מחדש |
| `rejected` | נדחה | הבקשה נדחתה |

### 5.2 סטטוסי CRM

| סטטוס | תיאור |
|-------|--------|
| `active` | ספק פעיל |
| `suspended` | ספק מושהה |
| `closed` | ספק סגור |
| `vip` | ספק VIP |
| `security_approved` | אושר ביטחון |

### 5.3 סטטוסי הצעת מחיר

| סטטוס | תיאור |
|-------|--------|
| `pending` | ממתין |
| `approved` | אושר |
| `rejected` | נדחה |

### 5.4 סטטוסי קבלה

| סטטוס | תיאור |
|-------|--------|
| `pending` | ממתין לסקירה |
| `approved` | אושר |
| `rejected` | נדחה |

---

## 6. התראות ומיילים

### 6.1 התראות אוטומטיות

| אירוע | נמען | Edge Function |
|-------|------|---------------|
| יצירת בקשה חדשה | ספק | `send-vendor-email` |
| אימות OTP | ספק | `send-vendor-otp` |
| הספק שלח טופס | מטפל | `send-handler-notification` |
| בקשת אישור | מנהל | `send-approval-request` |
| בקשת אישור מנהל | מנהל | `send-manager-approval` |
| ספק אושר | ספק | `send-vendor-confirmation` |
| ספק נדחה | ספק | `send-vendor-rejection` |
| בקשת הצעת מחיר | ספק | `send-quote-request` |
| אישור הצעת מחיר | מאשר | `send-quote-approval-email` |
| קישור קבלות | ספק | `send-receipts-link` |
| סטטוס קבלה | ספק | `send-receipt-status` |
| תזכורת פג תוקף | מטפל | `send-expiry-reminder` |

---

## 7. Edge Functions

### 7.1 רשימת פונקציות

| פונקציה | תיאור |
|---------|--------|
| `approve-user` | אישור משתמש חדש |
| `classify-document` | סיווג סוג מסמך באמצעות AI |
| `detect-signature-position` | זיהוי מיקום חתימה ב-PDF |
| `extract-bank-details` | חילוץ פרטי בנק ממסמך |
| `extract-document-data` | חילוץ נתונים ממסמך |
| `extract-document-text` | חילוץ טקסט ממסמך |
| `handle-manager-approval` | טיפול באישור מנהל |
| `search-streets` | חיפוש רחובות לפי עיר |
| `send-approval-request` | שליחת בקשת אישור |
| `send-expiry-reminder` | שליחת תזכורת פג תוקף |
| `send-handler-notification` | התראה למטפל |
| `send-manager-approval` | שליחת בקשה למנהל |
| `send-quote-approval-email` | מייל אישור הצעה |
| `send-quote-request` | שליחת בקשת הצעת מחיר |
| `send-receipt-status` | עדכון סטטוס קבלה |
| `send-receipts-link` | שליחת קישור קבלות |
| `send-vendor-confirmation` | אישור ספק |
| `send-vendor-email` | מייל לספק |
| `send-vendor-otp` | שליחת קוד אימות |
| `send-vendor-rejection` | דחיית ספק |
| `vendor-form-api` | API לטופס ספק |
| `vendor-quote-details` | פרטי הצעת מחיר |
| `vendor-quote-submit` | שליחת הצעת מחיר |
| `vendor-receipt-upload` | העלאת קבלה |
| `vendor-status` | סטטוס ספק |
| `vendor-upload` | העלאת מסמכים |
| `verify-vendor-otp` | אימות קוד OTP |

---

## 8. אבטחה

### 8.1 מנגנוני אבטחה
- **הזדהות:** Supabase Auth
- **אישור משתמשים:** כל משתמש חדש ממתין לאישור אדמין
- **תפקידים:** `admin` / `user`
- **קישורים מאובטחים:** Token ייחודי לכל ספק
- **OTP:** אימות דו-שלבי לספקים
- **RLS:** Row Level Security על כל הטבלאות
- **תוקף קישורים:** קישורים לספק פגי תוקף

### 8.2 הרשאות לפי תפקיד

| פעולה | משתמש | אדמין |
|-------|-------|-------|
| צפייה בבקשות שלי | ✓ | ✓ |
| צפייה בכל הבקשות | ✗ | ✓ |
| יצירת בקשה | ✓ | ✓ |
| הגדרות מערכת | ✗ | ✓ |
| אישור משתמשים | ✗ | ✓ |
| ניהול CRM | ✓ | ✓ |

---

## 9. תכונות AI

### 9.1 חילוץ נתונים אוטומטי
- זיהוי פרטי בנק מהמחאה/אישור בנק
- חילוץ פרטי חברה ממסמכים
- זיהוי מספר ח.פ

### 9.2 סיווג מסמכים
- זיהוי אוטומטי של סוג מסמך
- התראה על אי-התאמה

### 9.3 זיהוי מיקום חתימה
- זיהוי אוטומטי של מיקום לחתימה ב-PDF

---

## 10. דוחות והיסטוריה

### 10.1 היסטוריית סטטוסים
- מעקב אחר כל שינוי סטטוס
- תיעוד מי ביצע ומתי

### 10.2 היסטוריית CRM
- מעקב אחר שינויים בפרטי ספק
- תיעוד ערך ישן וחדש

### 10.3 דירוג ספקים
- דירוג לפי משתמש
- ממוצע דירוג כללי

---

## 11. נספחים

### 11.1 סוגי ספקים
- **ספק משרד** - ספקים כלליים
- **ספק תביעות** - ספקים לתחום תביעות
  - דירה (שרברב, חברת ניהול)
  - רכב (מוסך, שמאי)
  - חיים (רופא, עורך דין)
  - בריאות (רופא, עורך דין)

### 11.2 סוגי מסמכים
- אישור ניהול ספרים
- אישור ניכוי מס במקור
- צילום המחאה / אישור בנק
- צילום חשבונית

### 11.3 אמצעי תשלום
- המחאה
- מס"ב (העברה בנקאית)
- העברה בנקאית

---

## 12. גרסאות עתידיות

### תכונות מתוכננות:
- [ ] אינטגרציה עם מערכת ERP
- [ ] דוחות מתקדמים
- [ ] התראות SMS
- [ ] חיבור למערכת חתימות דיגיטליות חיצונית
- [ ] API חיצוני לאינטגרציות
- [ ] אפליקציית מובייל

---

**סוף המסמך**
